<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>A Special Message For You</title>
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=VT323&display=swap" rel="stylesheet">
<style>
  :root {
    --pink: #FFB6C1;
    --soft-pink: #FFD1DC;
    --lavender: #C8A2D4;
    --baby-blue: #A8D8EA;
    --cream: #FFF5F5;
    --red: #E74C6F;
    --deep-pink: #D4577A;
    --white: #FFFFFF;
    --gold: #FFD700;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    width: 100vw;
    height: 100vh;
    overflow: hidden;
    font-family: 'Press Start 2P', cursive;
    background: var(--cream);
    cursor: default;
  }

  /* ========== PIXEL HEARTS (CSS only, no emojis) ========== */
  .pixel-heart-sm {
    --h-color: var(--red);
    width: 24px;
    height: 22px;
    position: relative;
  }
  .pixel-heart-sm::before,
  .pixel-heart-sm::after {
    content: '';
    position: absolute;
    width: 12px;
    height: 12px;
    background: var(--h-color);
    border-radius: 50% 50% 0 0;
  }
  .pixel-heart-sm::before {
    left: 1px;
    top: 0;
    transform: rotate(-45deg);
    transform-origin: bottom right;
  }
  .pixel-heart-sm::after {
    right: 1px;
    top: 0;
    transform: rotate(45deg);
    transform-origin: bottom left;
  }

  .pixel-heart {
    width: 36px;
    height: 32px;
    position: relative;
  }
  .pixel-heart::before,
  .pixel-heart::after {
    content: '';
    position: absolute;
    width: 18px;
    height: 18px;
    background: var(--red);
    border-radius: 50% 50% 0 0;
  }
  .pixel-heart::before {
    left: 1px;
    top: 0;
    transform: rotate(-45deg);
    transform-origin: bottom right;
  }
  .pixel-heart::after {
    right: 1px;
    top: 0;
    transform: rotate(45deg);
    transform-origin: bottom left;
  }

  .pixel-heart-lg {
    width: 60px;
    height: 54px;
    position: relative;
    animation: heartBeat 1s ease-in-out infinite;
  }
  .pixel-heart-lg::before,
  .pixel-heart-lg::after {
    content: '';
    position: absolute;
    width: 32px;
    height: 32px;
    background: var(--red);
    border-radius: 50% 50% 0 0;
  }
  .pixel-heart-lg::before {
    left: 0;
    top: 0;
    transform: rotate(-45deg);
    transform-origin: bottom right;
  }
  .pixel-heart-lg::after {
    right: 0;
    top: 0;
    transform: rotate(45deg);
    transform-origin: bottom left;
  }

  /* ========== PIXEL HELPERS ========== */
  .pixel-border {
    box-shadow:
      4px 0 0 0 currentColor,
      -4px 0 0 0 currentColor,
      0 4px 0 0 currentColor,
      0 -4px 0 0 currentColor;
  }

  /* ========== STAGE SYSTEM ========== */
  .stage {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.6s ease;
  }
  .stage.active {
    opacity: 1;
    pointer-events: all;
  }

  /* ========== STAGE 1: PLAY BUTTON ========== */
  #stage-play {
    background: linear-gradient(135deg, var(--soft-pink) 0%, var(--lavender) 50%, var(--baby-blue) 100%);
  }

  .play-wrapper {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 30px;
  }

  .play-title {
    font-family: 'Press Start 2P', cursive;
    font-size: 14px;
    color: var(--deep-pink);
    text-align: center;
    line-height: 2;
    text-shadow: 2px 2px 0 rgba(255,255,255,0.5);
    animation: floatText 3s ease-in-out infinite;
  }

  @keyframes floatText {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-6px); }
  }

  .play-btn {
    position: relative;
    width: 160px;
    height: 160px;
    background: var(--red);
    border: none;
    cursor: pointer;
    border-radius: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: transform 0.2s, box-shadow 0.2s;
    box-shadow:
      0 8px 0 #c0394f,
      0 12px 20px rgba(0,0,0,0.15),
      inset 0 -4px 0 rgba(0,0,0,0.1),
      inset 0 4px 0 rgba(255,255,255,0.2);
    image-rendering: pixelated;
    animation: playPulse 2s ease-in-out infinite;
  }

  @keyframes playPulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.05); }
  }

  .play-btn:hover {
    animation: none;
    transform: scale(1.1);
    box-shadow:
      0 10px 0 #c0394f,
      0 16px 30px rgba(0,0,0,0.2),
      inset 0 -4px 0 rgba(0,0,0,0.1),
      inset 0 4px 0 rgba(255,255,255,0.2);
  }

  .play-btn:active {
    transform: scale(0.95);
    box-shadow:
      0 4px 0 #c0394f,
      0 6px 10px rgba(0,0,0,0.15),
      inset 0 -2px 0 rgba(0,0,0,0.1),
      inset 0 2px 0 rgba(255,255,255,0.2);
  }

  /* Pixel play triangle */
  .play-triangle {
    width: 0;
    height: 0;
    border-style: solid;
    border-width: 35px 0 35px 60px;
    border-color: transparent transparent transparent white;
    margin-left: 10px;
    filter: drop-shadow(2px 2px 0 rgba(0,0,0,0.1));
  }

  /* Pixel dots decoration around play button */
  .pixel-dots {
    position: absolute;
    width: 200px;
    height: 200px;
    pointer-events: none;
  }
  .pixel-dots span {
    position: absolute;
    width: 8px;
    height: 8px;
    background: var(--red);
    opacity: 0.4;
    animation: twinkle 2s ease-in-out infinite;
  }
  .pixel-dots span:nth-child(1) { top: 0; left: 50%; animation-delay: 0s; }
  .pixel-dots span:nth-child(2) { top: 20%; right: 0; animation-delay: 0.3s; }
  .pixel-dots span:nth-child(3) { bottom: 0; left: 50%; animation-delay: 0.6s; }
  .pixel-dots span:nth-child(4) { top: 20%; left: 0; animation-delay: 0.9s; }
  .pixel-dots span:nth-child(5) { top: 50%; right: -10px; animation-delay: 1.2s; }
  .pixel-dots span:nth-child(6) { top: 50%; left: -10px; animation-delay: 1.5s; }

  @keyframes twinkle {
    0%, 100% { opacity: 0.2; transform: scale(1); }
    50% { opacity: 0.8; transform: scale(1.5); }
  }

  .play-hint {
    font-family: 'VT323', monospace;
    font-size: 20px;
    color: var(--deep-pink);
    animation: blink 1.2s step-end infinite;
  }

  @keyframes blink {
    0%, 100% { opacity: 1; }
    50% { opacity: 0; }
  }

  /* ========== FLOATING PIXEL HEARTS (Stage 1) ========== */
  .floating-hearts {
    position: absolute;
    inset: 0;
    pointer-events: none;
    overflow: hidden;
  }
  .floating-hearts .heart {
    position: absolute;
    font-size: 20px;
    animation: floatUp linear infinite;
    image-rendering: pixelated;
  }

  @keyframes floatUp {
    0% { transform: translateY(100vh) rotate(0deg); opacity: 0.8; }
    100% { transform: translateY(-100px) rotate(360deg); opacity: 0; }
  }

  /* ========== STAGE 2: ENVELOPE ========== */
  #stage-envelope {
    background: linear-gradient(180deg, var(--baby-blue) 0%, var(--soft-pink) 100%);
  }

  .envelope-hint {
    font-family: 'VT323', monospace;
    font-size: 22px;
    color: var(--deep-pink);
    margin-bottom: 30px;
    animation: blink 1.2s step-end infinite;
  }

  .envelope-container {
    position: relative;
    width: 280px;
    height: 200px;
    cursor: pointer;
    transition: transform 0.3s;
  }
  .envelope-container:hover {
    transform: scale(1.05);
  }

  .envelope-body {
    position: absolute;
    bottom: 0;
    width: 280px;
    height: 180px;
    background: var(--white);
    border: 4px solid var(--deep-pink);
    border-radius: 4px;
    z-index: 2;
    overflow: hidden;
  }

  .envelope-body::after {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 100%;
    background: linear-gradient(135deg, transparent 48%, var(--soft-pink) 48%, var(--soft-pink) 52%, transparent 52%),
                linear-gradient(225deg, transparent 48%, var(--soft-pink) 48%, var(--soft-pink) 52%, transparent 52%);
    opacity: 0.3;
  }

  /* Heart seal on envelope */
  .envelope-seal {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 36px;
    z-index: 5;
    animation: sealPulse 1.5s ease-in-out infinite;
    filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
  }

  @keyframes sealPulse {
    0%, 100% { transform: translate(-50%, -50%) scale(1); }
    50% { transform: translate(-50%, -50%) scale(1.15); }
  }

  /* Envelope flap */
  .envelope-flap {
    position: absolute;
    top: 0;
    left: 0;
    width: 0;
    height: 0;
    border-left: 140px solid transparent;
    border-right: 140px solid transparent;
    border-top: 100px solid var(--pink);
    z-index: 3;
    transform-origin: top center;
    transition: transform 0.8s ease;
    filter: drop-shadow(0 2px 3px rgba(0,0,0,0.1));
  }

  .envelope-flap-border {
    position: absolute;
    top: -4px;
    left: -4px;
    width: 0;
    height: 0;
    border-left: 144px solid transparent;
    border-right: 144px solid transparent;
    border-top: 104px solid var(--deep-pink);
    z-index: 2;
    transform-origin: top center;
    transition: transform 0.8s ease;
  }

  .envelope-container.opening .envelope-flap,
  .envelope-container.opening .envelope-flap-border {
    transform: rotateX(180deg);
  }

  /* Letter peeking out */
  .envelope-letter {
    position: absolute;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    width: 240px;
    height: 160px;
    background: var(--cream);
    border: 3px solid var(--lavender);
    border-radius: 4px;
    z-index: 1;
    transition: top 0.6s ease 0.4s;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 15px;
  }

  .envelope-letter-text {
    font-family: 'Press Start 2P', cursive;
    font-size: 8px;
    color: var(--deep-pink);
    text-align: center;
    line-height: 2;
  }

  .envelope-container.opening .envelope-letter {
    top: -120px;
  }

  .envelope-container.opening .envelope-seal {
    opacity: 0;
    transition: opacity 0.3s;
  }

  /* Sparkles around envelope */
  .sparkle {
    position: absolute;
    width: 6px;
    height: 6px;
    background: var(--gold);
    animation: sparkle 1.5s ease-in-out infinite;
  }

  @keyframes sparkle {
    0%, 100% { opacity: 0; transform: scale(0) rotate(0deg); }
    50% { opacity: 1; transform: scale(1) rotate(180deg); }
  }

  /* ========== STAGE 3: VALENTINE QUESTION ========== */
  #stage-question {
    background: linear-gradient(180deg, var(--baby-blue) 0%, var(--cream) 50%, var(--soft-pink) 100%);
  }

  .question-text {
    font-family: 'Press Start 2P', cursive;
    font-size: 18px;
    color: var(--deep-pink);
    text-align: center;
    line-height: 2.2;
    margin-bottom: 50px;
    text-shadow: 2px 2px 0 rgba(255,255,255,0.8);
    animation: questionBounce 2s ease-in-out infinite;
  }

  @keyframes questionBounce {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-8px); }
  }

  .question-emoji {
    font-size: 60px;
    margin-bottom: 30px;
    animation: heartBeat 1s ease-in-out infinite;
  }

  @keyframes heartBeat {
    0%, 100% { transform: scale(1); }
    15% { transform: scale(1.15); }
    30% { transform: scale(1); }
    45% { transform: scale(1.1); }
  }

  .btn-container {
    display: flex;
    gap: 40px;
    align-items: center;
    position: relative;
  }

  .btn-yes, .btn-no {
    font-family: 'Press Start 2P', cursive;
    font-size: 14px;
    padding: 18px 36px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition: transform 0.15s, box-shadow 0.15s;
    image-rendering: pixelated;
  }

  .btn-yes {
    background: var(--red);
    color: white;
    box-shadow:
      0 6px 0 #c0394f,
      0 8px 15px rgba(0,0,0,0.15);
  }
  .btn-yes:hover {
    transform: translateY(-3px);
    box-shadow:
      0 9px 0 #c0394f,
      0 12px 20px rgba(0,0,0,0.2);
  }
  .btn-yes:active {
    transform: translateY(2px);
    box-shadow:
      0 3px 0 #c0394f,
      0 4px 8px rgba(0,0,0,0.15);
  }

  .btn-no {
    background: var(--lavender);
    color: white;
    box-shadow:
      0 6px 0 #a07fb5,
      0 8px 15px rgba(0,0,0,0.1);
    position: absolute;
    right: -60px;
    transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    z-index: 10;
  }

  /* ========== CLOUDS ========== */
  .clouds-container {
    position: absolute;
    inset: 0;
    pointer-events: none;
    overflow: hidden;
    z-index: 1;
  }

  .pixel-cloud {
    position: absolute;
    background: rgba(255, 255, 255, 0.7);
    border-radius: 8px;
    animation: driftCloud linear infinite;
  }

  .pixel-cloud::before,
  .pixel-cloud::after {
    content: '';
    position: absolute;
    background: rgba(255, 255, 255, 0.7);
    border-radius: 8px;
  }

  .pixel-cloud::before {
    width: 60%;
    height: 70%;
    top: -40%;
    left: 20%;
  }

  .pixel-cloud::after {
    width: 40%;
    height: 50%;
    top: -25%;
    left: 55%;
  }

  @keyframes driftCloud {
    0% { transform: translateX(-200px); }
    100% { transform: translateX(calc(100vw + 200px)); }
  }

  /* ========== STAGE 4: CELEBRATION ========== */
  #stage-celebrate {
    background: linear-gradient(135deg, var(--soft-pink) 0%, var(--lavender) 40%, var(--baby-blue) 70%, var(--soft-pink) 100%);
    background-size: 300% 300%;
    animation: gradientShift 4s ease infinite;
  }

  @keyframes gradientShift {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
  }

  .celebrate-card {
    background: var(--white);
    border: 6px solid var(--deep-pink);
    border-radius: 16px;
    padding: 50px 60px;
    text-align: center;
    box-shadow:
      0 0 0 4px var(--soft-pink),
      0 0 0 8px var(--lavender),
      0 20px 60px rgba(0,0,0,0.15);
    animation: cardAppear 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
    position: relative;
    z-index: 2;
    max-width: 90vw;
  }

  @keyframes cardAppear {
    0% { transform: scale(0) rotate(-10deg); opacity: 0; }
    100% { transform: scale(1) rotate(0deg); opacity: 1; }
  }

  .celebrate-emoji {
    font-size: 64px;
    margin-bottom: 20px;
    animation: heartBeat 1s ease-in-out infinite;
  }

  .celebrate-title {
    font-family: 'Press Start 2P', cursive;
    font-size: 22px;
    color: var(--red);
    line-height: 2;
    margin-bottom: 15px;
    animation: rainbowText 2s ease-in-out infinite;
  }

  @keyframes rainbowText {
    0%, 100% { color: var(--red); }
    33% { color: var(--deep-pink); }
    66% { color: var(--lavender); }
  }

  .celebrate-subtitle {
    font-family: 'Press Start 2P', cursive;
    font-size: 12px;
    color: var(--lavender);
    line-height: 2.2;
  }

  /* Confetti */
  .confetti-container {
    position: absolute;
    inset: 0;
    pointer-events: none;
    overflow: hidden;
    z-index: 1;
  }

  .confetti {
    position: absolute;
    top: -20px;
    animation: confettiFall linear infinite;
  }

  @keyframes confettiFall {
    0% { transform: translateY(-20px) rotate(0deg); opacity: 1; }
    100% { transform: translateY(100vh) rotate(720deg); opacity: 0.6; }
  }

  /* Hearts rain for celebration */
  .hearts-rain {
    position: absolute;
    inset: 0;
    pointer-events: none;
    overflow: hidden;
    z-index: 1;
  }

  .rain-heart {
    position: absolute;
    top: -30px;
    animation: heartRain linear infinite;
  }

  @keyframes heartRain {
    0% { transform: translateY(-30px) scale(1); opacity: 0.9; }
    100% { transform: translateY(100vh) scale(0.5); opacity: 0; }
  }

  /* ========== SCREEN FLASH ========== */
  .flash-overlay {
    position: fixed;
    inset: 0;
    background: white;
    z-index: 999;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.15s;
  }
  .flash-overlay.active {
    opacity: 1;
  }

  /* ========== RESPONSIVE ========== */
  @media (max-width: 600px) {
    .play-btn { width: 120px; height: 120px; }
    .play-triangle { border-width: 25px 0 25px 44px; margin-left: 8px; }
    .play-title { font-size: 11px; }
    .question-text { font-size: 13px; margin-bottom: 30px; }
    .btn-yes, .btn-no { font-size: 11px; padding: 14px 24px; }
    .celebrate-title { font-size: 16px; }
    .celebrate-subtitle { font-size: 9px; }
    .celebrate-card { padding: 30px 25px; }
    .envelope-container { width: 220px; height: 170px; }
    .envelope-body { width: 220px; height: 150px; }
    .envelope-flap { border-left: 110px solid transparent; border-right: 110px solid transparent; border-top: 80px solid var(--pink); }
    .envelope-flap-border { border-left: 114px solid transparent; border-right: 114px solid transparent; border-top: 84px solid var(--deep-pink); }
    .envelope-letter { width: 190px; }
  }
</style>
</head>
<body>

<!-- Flash overlay for transitions -->
<div class="flash-overlay" id="flash"></div>

<!-- ========== STAGE 1: PLAY BUTTON ========== -->
<div class="stage active" id="stage-play">
  <div class="floating-hearts" id="floatingHearts"></div>
  <div class="play-wrapper">
    <div class="play-title">~ a special message ~<br>just for you ~</div>
    <button class="play-btn" id="playBtn" onclick="goToEnvelope()">
      <div class="pixel-dots">
        <span></span><span></span><span></span>
        <span></span><span></span><span></span>
      </div>
      <div class="play-triangle"></div>
    </button>
    <div class="play-hint">[ PRESS PLAY ]</div>
  </div>
</div>

<!-- ========== STAGE 2: ENVELOPE ========== -->
<div class="stage" id="stage-envelope">
  <div class="clouds-container" id="envelopeClouds"></div>
  <div class="envelope-hint">tap to open</div>
  <div class="envelope-container" id="envelope" onclick="openEnvelope()">
    <div class="envelope-seal pixel-heart"></div>
    <div class="envelope-flap-border"></div>
    <div class="envelope-flap"></div>
    <div class="envelope-letter">
      <div class="envelope-letter-text">FOR YOU</div>
    </div>
    <div class="envelope-body"></div>
    <!-- sparkles -->
    <div class="sparkle" style="top:-10px;left:20px;animation-delay:0s;"></div>
    <div class="sparkle" style="top:30px;right:-15px;animation-delay:0.4s;"></div>
    <div class="sparkle" style="bottom:-5px;left:50%;animation-delay:0.8s;"></div>
    <div class="sparkle" style="top:50%;left:-12px;animation-delay:1.2s;"></div>
  </div>
</div>

<!-- ========== STAGE 3: VALENTINE QUESTION ========== -->
<div class="stage" id="stage-question">
  <div class="clouds-container" id="questionClouds"></div>
  <div class="question-emoji pixel-heart-lg"></div>
  <div class="question-text">Tanieal...<br>Will you be<br>my Valentine?</div>
  <div class="btn-container" id="btnContainer">
    <button class="btn-yes" onclick="sayYes()">YES!</button>
    <button class="btn-no" id="btnNo">No...</button>
  </div>
</div>

<!-- ========== STAGE 4: CELEBRATION ========== -->
<div class="stage" id="stage-celebrate">
  <div class="confetti-container" id="confettiContainer"></div>
  <div class="hearts-rain" id="heartsRain"></div>
  <div class="celebrate-card">
    <div class="celebrate-title">WOOOOO!!!<br>MY CUTIE!!!!</div>
    <div class="celebrate-subtitle">happy Valentine's Day</div>
  </div>
</div>

<script>
  // ======== FLOATING HEARTS (Stage 1) ========
  const heartColors = ['var(--pink)', 'var(--soft-pink)', 'var(--lavender)', 'var(--baby-blue)', 'var(--red)', 'var(--deep-pink)'];
  const heartsContainer = document.getElementById('floatingHearts');

  function spawnFloatingHeart() {
    const heart = document.createElement('div');
    heart.className = 'heart pixel-heart-sm';
    const color = heartColors[Math.floor(Math.random() * heartColors.length)];
    heart.style.setProperty('--h-color', color);
    heart.style.left = Math.random() * 100 + '%';
    const size = 0.6 + Math.random() * 1;
    heart.style.transform = `scale(${size})`;
    heart.style.animationDuration = (4 + Math.random() * 6) + 's';
    heart.style.animationDelay = Math.random() * 2 + 's';
    heartsContainer.appendChild(heart);
    setTimeout(() => heart.remove(), 12000);
  }

  setInterval(spawnFloatingHeart, 600);
  for (let i = 0; i < 8; i++) setTimeout(spawnFloatingHeart, i * 200);

  // ======== CLOUDS ========
  function createClouds(containerId, count) {
    const container = document.getElementById(containerId);
    for (let i = 0; i < count; i++) {
      const cloud = document.createElement('div');
      cloud.className = 'pixel-cloud';
      const w = 80 + Math.random() * 100;
      cloud.style.width = w + 'px';
      cloud.style.height = (w * 0.4) + 'px';
      cloud.style.top = (Math.random() * 70) + '%';
      cloud.style.animationDuration = (15 + Math.random() * 20) + 's';
      cloud.style.animationDelay = (-Math.random() * 30) + 's';
      cloud.style.opacity = 0.4 + Math.random() * 0.4;
      container.appendChild(cloud);
    }
  }

  createClouds('envelopeClouds', 6);
  createClouds('questionClouds', 8);

  // ======== STAGE TRANSITIONS ========
  function flash(callback) {
    const el = document.getElementById('flash');
    el.classList.add('active');
    setTimeout(() => {
      callback();
      setTimeout(() => el.classList.remove('active'), 300);
    }, 200);
  }

  function switchStage(from, to) {
    document.getElementById(from).classList.remove('active');
    document.getElementById(to).classList.add('active');
  }

  function goToEnvelope() {
    flash(() => switchStage('stage-play', 'stage-envelope'));
  }

  let envelopeOpened = false;
  function openEnvelope() {
    if (envelopeOpened) return;
    const env = document.getElementById('envelope');
    env.classList.add('opening');
    envelopeOpened = true;

    setTimeout(() => {
      flash(() => {
        switchStage('stage-envelope', 'stage-question');
        initNoButton();
      });
    }, 1400);
  }

  // ======== FLEEING NO BUTTON ========
  function initNoButton() {
    const btn = document.getElementById('btnNo');
    const sensitivity = 120;

    function flee(e) {
      const rect = btn.getBoundingClientRect();
      const btnCX = rect.left + rect.width / 2;
      const btnCY = rect.top + rect.height / 2;

      const dx = e.clientX - btnCX;
      const dy = e.clientY - btnCY;
      const dist = Math.sqrt(dx * dx + dy * dy);

      if (dist < sensitivity) {
        const vw = window.innerWidth;
        const vh = window.innerHeight;
        const bw = rect.width;
        const bh = rect.height;
        const pad = 20;

        let newX, newY;
        let attempts = 0;
        do {
          newX = pad + Math.random() * (vw - bw - pad * 2);
          newY = pad + Math.random() * (vh - bh - pad * 2);
          attempts++;
        } while (
          Math.sqrt((e.clientX - (newX + bw/2))**2 + (e.clientY - (newY + bh/2))**2) < sensitivity * 1.5
          && attempts < 20
        );

        btn.style.position = 'fixed';
        btn.style.left = newX + 'px';
        btn.style.top = newY + 'px';
        btn.style.right = 'auto';
      }
    }

    document.addEventListener('mousemove', flee);
    document.addEventListener('touchmove', (e) => {
      const touch = e.touches[0];
      flee({ clientX: touch.clientX, clientY: touch.clientY });
    });

    // Also flee on touch start (for mobile)
    btn.addEventListener('touchstart', (e) => {
      e.preventDefault();
      const touch = e.touches[0];
      flee({ clientX: touch.clientX, clientY: touch.clientY });
    });
  }

  // ======== CELEBRATION ========
  let audioCtx;
  function playVictorySound() {
    try {
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();

      const notes = [523.25, 659.25, 783.99, 1046.50]; // C5, E5, G5, C6
      notes.forEach((freq, i) => {
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = 'square'; // Pixel/retro sound
        osc.frequency.value = freq;
        gain.gain.setValueAtTime(0.08, audioCtx.currentTime + i * 0.15);
        gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + i * 0.15 + 0.5);
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        osc.start(audioCtx.currentTime + i * 0.15);
        osc.stop(audioCtx.currentTime + i * 0.15 + 0.5);
      });

      // Second arpeggio
      setTimeout(() => {
        const notes2 = [659.25, 783.99, 1046.50, 1318.51];
        notes2.forEach((freq, i) => {
          const osc = audioCtx.createOscillator();
          const gain = audioCtx.createGain();
          osc.type = 'square';
          osc.frequency.value = freq;
          gain.gain.setValueAtTime(0.08, audioCtx.currentTime + i * 0.12);
          gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + i * 0.12 + 0.6);
          osc.connect(gain);
          gain.connect(audioCtx.destination);
          osc.start(audioCtx.currentTime + i * 0.12);
          osc.stop(audioCtx.currentTime + i * 0.12 + 0.6);
        });
      }, 600);

      // Background heartbeat melody loop
      setTimeout(() => {
        function playLoop() {
          const melody = [523.25, 0, 659.25, 0, 783.99, 659.25, 523.25, 0];
          melody.forEach((freq, i) => {
            if (freq === 0) return;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = 'triangle';
            osc.frequency.value = freq;
            gain.gain.setValueAtTime(0.04, audioCtx.currentTime + i * 0.25);
            gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + i * 0.25 + 0.24);
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start(audioCtx.currentTime + i * 0.25);
            osc.stop(audioCtx.currentTime + i * 0.25 + 0.25);
          });
        }
        playLoop();
        setInterval(playLoop, 2200);
      }, 1400);

    } catch(e) {
      console.log('Audio not supported');
    }
  }

  function spawnConfetti() {
    const container = document.getElementById('confettiContainer');
    const colors = ['#FFB6C1', '#C8A2D4', '#A8D8EA', '#FFD700', '#FF6B8A', '#98D8C8', '#F7DC6F'];

    function createPiece() {
      const piece = document.createElement('div');
      piece.className = 'confetti';
      piece.style.left = Math.random() * 100 + '%';
      piece.style.width = (6 + Math.random() * 10) + 'px';
      piece.style.height = (6 + Math.random() * 10) + 'px';
      piece.style.background = colors[Math.floor(Math.random() * colors.length)];
      piece.style.animationDuration = (2 + Math.random() * 3) + 's';
      piece.style.animationDelay = Math.random() * 3 + 's';
      piece.style.borderRadius = Math.random() > 0.5 ? '50%' : '2px';
      container.appendChild(piece);
      setTimeout(() => piece.remove(), 6000);
    }

    for (let i = 0; i < 50; i++) setTimeout(() => createPiece(), i * 60);
    setInterval(() => { for(let i=0;i<3;i++) createPiece(); }, 400);
  }

  function spawnHeartsRain() {
    const container = document.getElementById('heartsRain');
    function createHeart() {
      const h = document.createElement('div');
      h.className = 'rain-heart pixel-heart-sm';
      const color = heartColors[Math.floor(Math.random() * heartColors.length)];
      h.style.setProperty('--h-color', color);
      h.style.left = Math.random() * 100 + '%';
      const size = 0.5 + Math.random() * 1;
      h.style.transform = `scale(${size})`;
      h.style.animationDuration = (3 + Math.random() * 4) + 's';
      h.style.animationDelay = Math.random() * 2 + 's';
      container.appendChild(h);
      setTimeout(() => h.remove(), 8000);
    }
    for (let i = 0; i < 15; i++) setTimeout(() => createHeart(), i * 150);
    setInterval(createHeart, 500);
  }

  function sayYes() {
    flash(() => {
      switchStage('stage-question', 'stage-celebrate');
      playVictorySound();
      spawnConfetti();
      spawnHeartsRain();
    });
  }
</script>
</body>
</html>
