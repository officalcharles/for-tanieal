<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>A Special Message For You</title>
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=VT323&display=swap" rel="stylesheet">
<style>
  :root {
    --pink: #FFB6C1;
    --soft-pink: #FFD1DC;
    --lavender: #C8A2D4;
    --baby-blue: #A8D8EA;
    --cream: #FFF5F5;
    --red: #E74C6F;
    --deep-pink: #D4577A;
    --white: #FFFFFF;
    --gold: #FFD700;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    width: 100vw;
    height: 100vh;
    overflow: hidden;
    font-family: 'Press Start 2P', cursive;
    background: var(--cream);
    cursor: default;
  }

  /* ========== PIXEL HEARTS (CSS only, no emojis) ========== */
  .pixel-heart-sm {
    --h-color: var(--red);
    width: 24px;
    height: 22px;
    position: relative;
  }
  .pixel-heart-sm::before,
  .pixel-heart-sm::after {
    content: '';
    position: absolute;
    width: 12px;
    height: 12px;
    background: var(--h-color);
    border-radius: 50% 50% 0 0;
  }
  .pixel-heart-sm::before {
    left: 1px;
    top: 0;
    transform: rotate(-45deg);
    transform-origin: bottom right;
  }
  .pixel-heart-sm::after {
    right: 1px;
    top: 0;
    transform: rotate(45deg);
    transform-origin: bottom left;
  }

  .pixel-heart {
    width: 36px;
    height: 32px;
    position: relative;
  }
  .pixel-heart::before,
  .pixel-heart::after {
    content: '';
    position: absolute;
    width: 18px;
    height: 18px;
    background: var(--red);
    border-radius: 50% 50% 0 0;
  }
  .pixel-heart::before {
    left: 1px;
    top: 0;
    transform: rotate(-45deg);
    transform-origin: bottom right;
  }
  .pixel-heart::after {
    right: 1px;
    top: 0;
    transform: rotate(45deg);
    transform-origin: bottom left;
  }

  .pixel-heart-lg {
    width: 60px;
    height: 54px;
    position: relative;
    animation: heartBeat 1s ease-in-out infinite;
  }
  .pixel-heart-lg::before,
  .pixel-heart-lg::after {
    content: '';
    position: absolute;
    width: 32px;
    height: 32px;
    background: var(--red);
    border-radius: 50% 50% 0 0;
  }
  .pixel-heart-lg::before {
    left: 0;
    top: 0;
    transform: rotate(-45deg);
    transform-origin: bottom right;
  }
  .pixel-heart-lg::after {
    right: 0;
    top: 0;
    transform: rotate(45deg);
    transform-origin: bottom left;
  }

  /* ========== PIXEL HELPERS ========== */
  .pixel-border {
    box-shadow:
      4px 0 0 0 currentColor,
      -4px 0 0 0 currentColor,
      0 4px 0 0 currentColor,
      0 -4px 0 0 currentColor;
  }

  /* ========== STAGE SYSTEM ========== */
  .stage {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.6s ease;
  }
  .stage.active {
    opacity: 1;
    pointer-events: all;
  }

  /* ========== STAGE 1: PLAY BUTTON ========== */
  #stage-play {
    background: linear-gradient(135deg, var(--soft-pink) 0%, var(--lavender) 50%, var(--baby-blue) 100%);
  }

  .play-wrapper {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 30px;
  }

  .play-title {
    font-family: 'Press Start 2P', cursive;
    font-size: 14px;
    color: var(--deep-pink);
    text-align: center;
    line-height: 2;
    text-shadow: 2px 2px 0 rgba(255,255,255,0.5);
    animation: floatText 3s ease-in-out infinite;
  }

  @keyframes floatText {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-6px); }
  }

  .play-btn {
    position: relative;
    width: 160px;
    height: 160px;
    background: var(--red);
    border: none;
    cursor: pointer;
    border-radius: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: transform 0.2s, box-shadow 0.2s;
    box-shadow:
      0 8px 0 #c0394f,
      0 12px 20px rgba(0,0,0,0.15),
      inset 0 -4px 0 rgba(0,0,0,0.1),
      inset 0 4px 0 rgba(255,255,255,0.2);
    image-rendering: pixelated;
    animation: playPulse 2s ease-in-out infinite;
  }

  @keyframes playPulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.05); }
  }

  .play-btn:hover {
    animation: none;
    transform: scale(1.1);
    box-shadow:
      0 10px 0 #c0394f,
      0 16px 30px rgba(0,0,0,0.2),
      inset 0 -4px 0 rgba(0,0,0,0.1),
      inset 0 4px 0 rgba(255,255,255,0.2);
  }

  .play-btn:active {
    transform: scale(0.95);
    box-shadow:
      0 4px 0 #c0394f,
      0 6px 10px rgba(0,0,0,0.15),
      inset 0 -2px 0 rgba(0,0,0,0.1),
      inset 0 2px 0 rgba(255,255,255,0.2);
  }

  /* Pixel play triangle */
  .play-triangle {
    width: 0;
    height: 0;
    border-style: solid;
    border-width: 35px 0 35px 60px;
    border-color: transparent transparent transparent white;
    margin-left: 10px;
    filter: drop-shadow(2px 2px 0 rgba(0,0,0,0.1));
  }

  /* Pixel dots decoration around play button */
  .pixel-dots {
    position: absolute;
    width: 200px;
    height: 200px;
    pointer-events: none;
  }
  .pixel-dots span {
    position: absolute;
    width: 8px;
    height: 8px;
    background: var(--red);
    opacity: 0.4;
    animation: twinkle 2s ease-in-out infinite;
  }
  .pixel-dots span:nth-child(1) { top: 0; left: 50%; animation-delay: 0s; }
  .pixel-dots span:nth-child(2) { top: 20%; right: 0; animation-delay: 0.3s; }
  .pixel-dots span:nth-child(3) { bottom: 0; left: 50%; animation-delay: 0.6s; }
  .pixel-dots span:nth-child(4) { top: 20%; left: 0; animation-delay: 0.9s; }
  .pixel-dots span:nth-child(5) { top: 50%; right: -10px; animation-delay: 1.2s; }
  .pixel-dots span:nth-child(6) { top: 50%; left: -10px; animation-delay: 1.5s; }

  @keyframes twinkle {
    0%, 100% { opacity: 0.2; transform: scale(1); }
    50% { opacity: 0.8; transform: scale(1.5); }
  }

  .play-hint {
    font-family: 'VT323', monospace;
    font-size: 20px;
    color: var(--deep-pink);
    animation: blink 1.2s step-end infinite;
  }

  @keyframes blink {
    0%, 100% { opacity: 1; }
    50% { opacity: 0; }
  }

  /* ========== FLOATING PIXEL HEARTS (Stage 1) ========== */
  .floating-hearts {
    position: absolute;
    inset: 0;
    pointer-events: none;
    overflow: hidden;
  }
  .floating-hearts .heart {
    position: absolute;
    font-size: 20px;
    animation: floatUp linear infinite;
    image-rendering: pixelated;
  }

  @keyframes floatUp {
    0% { transform: translateY(100vh) rotate(0deg); opacity: 0.8; }
    100% { transform: translateY(-100px) rotate(360deg); opacity: 0; }
  }

  /* ========== STAGE 2: ENVELOPE ========== */
  #stage-envelope {
    background: linear-gradient(180deg, var(--baby-blue) 0%, var(--soft-pink) 100%);
  }

  .envelope-hint {
    font-family: 'VT323', monospace;
    font-size: 22px;
    color: var(--deep-pink);
    margin-bottom: 30px;
    animation: blink 1.2s step-end infinite;
  }

  .envelope-container {
    position: relative;
    width: 280px;
    height: 200px;
    cursor: pointer;
    transition: transform 0.3s;
  }
  .envelope-container:hover {
    transform: scale(1.05);
  }

  .envelope-body {
    position: absolute;
    bottom: 0;
    width: 280px;
    height: 180px;
    background: var(--white);
    border: 4px solid var(--deep-pink);
    border-radius: 4px;
    z-index: 2;
    overflow: hidden;
  }

  .envelope-body::after {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 100%;
    background: linear-gradient(135deg, transparent 48%, var(--soft-pink) 48%, var(--soft-pink) 52%, transparent 52%),
                linear-gradient(225deg, transparent 48%, var(--soft-pink) 48%, var(--soft-pink) 52%, transparent 52%);
    opacity: 0.3;
  }

  /* Heart seal on envelope */
  .envelope-seal {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 36px;
    z-index: 5;
    animation: sealPulse 1.5s ease-in-out infinite;
    filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
  }

  @keyframes sealPulse {
    0%, 100% { transform: translate(-50%, -50%) scale(1); }
    50% { transform: translate(-50%, -50%) scale(1.15); }
  }

  /* Envelope flap */
  .envelope-flap {
    position: absolute;
    top: 0;
    left: 0;
    width: 0;
    height: 0;
    border-left: 140px solid transparent;
    border-right: 140px solid transparent;
    border-top: 100px solid var(--pink);
    z-index: 3;
    transform-origin: top center;
    transition: transform 0.8s ease;
    filter: drop-shadow(0 2px 3px rgba(0,0,0,0.1));
  }

  .envelope-flap-border {
    position: absolute;
    top: -4px;
    left: -4px;
    width: 0;
    height: 0;
    border-left: 144px solid transparent;
    border-right: 144px solid transparent;
    border-top: 104px solid var(--deep-pink);
    z-index: 2;
    transform-origin: top center;
    transition: transform 0.8s ease;
  }

  .envelope-container.opening .envelope-flap,
  .envelope-container.opening .envelope-flap-border {
    transform: rotateX(180deg);
  }

  /* Letter peeking out */
  .envelope-letter {
    position: absolute;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    width: 240px;
    height: 160px;
    background: var(--cream);
    border: 3px solid var(--lavender);
    border-radius: 4px;
    z-index: 1;
    transition: top 0.6s ease 0.4s;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 15px;
  }

  .envelope-letter-text {
    font-family: 'Press Start 2P', cursive;
    font-size: 8px;
    color: var(--deep-pink);
    text-align: center;
    line-height: 2;
  }

  .envelope-container.opening .envelope-letter {
    top: -120px;
  }

  .envelope-container.opening .envelope-seal {
    opacity: 0;
    transition: opacity 0.3s;
  }

  /* Sparkles around envelope */
  .sparkle {
    position: absolute;
    width: 6px;
    height: 6px;
    background: var(--gold);
    animation: sparkle 1.5s ease-in-out infinite;
  }

  @keyframes sparkle {
    0%, 100% { opacity: 0; transform: scale(0) rotate(0deg); }
    50% { opacity: 1; transform: scale(1) rotate(180deg); }
  }

  /* ========== STAGE 3: VALENTINE QUESTION ========== */
  #stage-question {
    background: linear-gradient(180deg, var(--baby-blue) 0%, var(--cream) 50%, var(--soft-pink) 100%);
  }

  .question-text {
    font-family: 'Press Start 2P', cursive;
    font-size: 18px;
    color: var(--deep-pink);
    text-align: center;
    line-height: 2.2;
    margin-bottom: 50px;
    text-shadow: 2px 2px 0 rgba(255,255,255,0.8);
    animation: questionBounce 2s ease-in-out infinite;
  }

  @keyframes questionBounce {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-8px); }
  }

  .question-emoji {
    font-size: 60px;
    margin-bottom: 30px;
    animation: heartBeat 1s ease-in-out infinite;
  }

  @keyframes heartBeat {
    0%, 100% { transform: scale(1); }
    15% { transform: scale(1.15); }
    30% { transform: scale(1); }
    45% { transform: scale(1.1); }
  }

  .btn-container {
    display: flex;
    gap: 40px;
    align-items: center;
    position: relative;
  }

  .btn-yes, .btn-no {
    font-family: 'Press Start 2P', cursive;
    font-size: 14px;
    padding: 18px 36px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition: transform 0.15s, box-shadow 0.15s;
    image-rendering: pixelated;
  }

  .btn-yes {
    background: var(--red);
    color: white;
    box-shadow:
      0 6px 0 #c0394f,
      0 8px 15px rgba(0,0,0,0.15);
  }
  .btn-yes:hover {
    transform: translateY(-3px);
    box-shadow:
      0 9px 0 #c0394f,
      0 12px 20px rgba(0,0,0,0.2);
  }
  .btn-yes:active {
    transform: translateY(2px);
    box-shadow:
      0 3px 0 #c0394f,
      0 4px 8px rgba(0,0,0,0.15);
  }

  .btn-no {
    background: var(--lavender);
    color: white;
    box-shadow:
      0 6px 0 #a07fb5,
      0 8px 15px rgba(0,0,0,0.1);
    position: absolute;
    right: -60px;
    transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    z-index: 10;
  }

  /* ========== CLOUDS ========== */
  .clouds-container {
    position: absolute;
    inset: 0;
    pointer-events: none;
    overflow: hidden;
    z-index: 1;
  }

  .pixel-cloud {
    position: absolute;
    background: rgba(255, 255, 255, 0.7);
    border-radius: 8px;
    animation: driftCloud linear infinite;
  }

  .pixel-cloud::before,
  .pixel-cloud::after {
    content: '';
    position: absolute;
    background: rgba(255, 255, 255, 0.7);
    border-radius: 8px;
  }

  .pixel-cloud::before {
    width: 60%;
    height: 70%;
    top: -40%;
    left: 20%;
  }

  .pixel-cloud::after {
    width: 40%;
    height: 50%;
    top: -25%;
    left: 55%;
  }

  @keyframes driftCloud {
    0% { transform: translateX(-200px); }
    100% { transform: translateX(calc(100vw + 200px)); }
  }

  /* ========== STAGE 4: LOVE SLIDER ========== */
  #stage-slider {
    background: linear-gradient(180deg, var(--soft-pink) 0%, var(--lavender) 50%, var(--baby-blue) 100%);
  }

  .slider-card {
    background: var(--white);
    border: 5px solid var(--deep-pink);
    border-radius: 16px;
    padding: 40px 50px;
    text-align: center;
    box-shadow: 0 15px 40px rgba(0,0,0,0.12);
    animation: cardAppear 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
    position: relative;
    z-index: 2;
    max-width: 90vw;
    width: 400px;
  }

  .slider-title {
    font-family: 'Press Start 2P', cursive;
    font-size: 16px;
    color: var(--deep-pink);
    line-height: 2.2;
    margin-bottom: 30px;
  }

  .slider-wrapper {
    margin-bottom: 20px;
  }

  .slider-labels {
    display: flex;
    justify-content: space-between;
    font-family: 'VT323', monospace;
    font-size: 18px;
    color: var(--lavender);
    margin-bottom: 10px;
  }

  .slider-labels span:last-child {
    color: var(--red);
    font-weight: bold;
  }

  /* Custom pixel slider */
  .love-slider {
    -webkit-appearance: none;
    appearance: none;
    width: 100%;
    height: 16px;
    background: linear-gradient(90deg, var(--baby-blue), var(--lavender), var(--pink), var(--red));
    border-radius: 4px;
    outline: none;
    border: 3px solid var(--deep-pink);
    cursor: pointer;
  }

  .love-slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 28px;
    height: 28px;
    background: var(--red);
    border: 3px solid var(--deep-pink);
    border-radius: 4px;
    cursor: pointer;
    box-shadow: 0 3px 0 #c0394f;
    transition: transform 0.1s;
  }

  .love-slider::-moz-range-thumb {
    width: 28px;
    height: 28px;
    background: var(--red);
    border: 3px solid var(--deep-pink);
    border-radius: 4px;
    cursor: pointer;
    box-shadow: 0 3px 0 #c0394f;
  }

  .love-slider:active::-webkit-slider-thumb {
    transform: scale(1.15);
  }

  .slider-value {
    font-family: 'Press Start 2P', cursive;
    font-size: 20px;
    color: var(--red);
    margin-top: 15px;
    min-height: 30px;
    transition: transform 0.15s;
  }

  .slider-hint {
    font-family: 'VT323', monospace;
    font-size: 18px;
    color: var(--lavender);
    margin-top: 8px;
    margin-bottom: 25px;
    min-height: 24px;
    transition: opacity 0.3s;
  }

  .slider-next-btn {
    margin-top: 5px;
  }

  .slider-value.nope {
    animation: sliderNope 0.3s ease;
  }

  @keyframes sliderNope {
    0%, 100% { transform: translateX(0); }
    20% { transform: translateX(-8px); }
    40% { transform: translateX(8px); }
    60% { transform: translateX(-5px); }
    80% { transform: translateX(5px); }
  }

  @media (max-width: 600px) {
    .slider-card { padding: 25px 20px; width: 90vw; }
    .slider-title { font-size: 13px; }
    .slider-value { font-size: 16px; }
  }

  /* ========== STAGE 5: TYPING ========== */
  #stage-typing {
    background: linear-gradient(180deg, var(--baby-blue) 0%, var(--soft-pink) 50%, var(--lavender) 100%);
  }

  .typing-card {
    background: var(--white);
    border: 5px solid var(--deep-pink);
    border-radius: 16px;
    padding: 40px 50px;
    text-align: center;
    box-shadow: 0 15px 40px rgba(0,0,0,0.12);
    animation: cardAppear 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
    position: relative;
    z-index: 2;
    max-width: 90vw;
    width: 440px;
  }

  .typing-title {
    font-family: 'Press Start 2P', cursive;
    font-size: 16px;
    color: var(--deep-pink);
    line-height: 2.2;
    margin-bottom: 25px;
  }

  .typing-box {
    background: var(--cream);
    border: 3px solid var(--lavender);
    border-radius: 8px;
    padding: 20px;
    min-height: 80px;
    text-align: left;
    font-family: 'VT323', monospace;
    font-size: 24px;
    color: var(--deep-pink);
    margin-bottom: 15px;
    cursor: text;
    position: relative;
  }

  .typing-cursor {
    animation: blink 0.6s step-end infinite;
    font-weight: bold;
    color: var(--red);
  }

  .typing-hint {
    font-family: 'VT323', monospace;
    font-size: 18px;
    color: var(--lavender);
    margin-bottom: 20px;
    min-height: 24px;
    transition: opacity 0.3s;
  }

  .typing-next-btn {
    animation: cardAppear 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
  }

  @media (max-width: 600px) {
    .typing-card { padding: 25px 20px; width: 90vw; }
    .typing-title { font-size: 13px; }
    .typing-box { font-size: 20px; padding: 15px; }
  }

  /* ========== STAGE 6: COMPLIMENTS ========== */
  #stage-compliments {
    background: linear-gradient(180deg, var(--lavender) 0%, var(--soft-pink) 50%, var(--baby-blue) 100%);
  }

  .compliments-card {
    background: var(--white);
    border: 5px solid var(--deep-pink);
    border-radius: 16px;
    padding: 35px 45px;
    text-align: center;
    box-shadow: 0 15px 40px rgba(0,0,0,0.12);
    animation: cardAppear 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
    position: relative;
    z-index: 2;
    max-width: 90vw;
    width: 440px;
    max-height: 85vh;
    overflow-y: auto;
  }

  .compliments-title {
    font-family: 'Press Start 2P', cursive;
    font-size: 14px;
    color: var(--deep-pink);
    line-height: 2.2;
    margin-bottom: 20px;
  }

  .compliments-list {
    text-align: left;
    margin-bottom: 15px;
  }

  .compliment-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 8px 12px;
    margin-bottom: 6px;
    border-radius: 8px;
    cursor: pointer;
    transition: background 0.2s, transform 0.15s;
    user-select: none;
  }

  .compliment-item:hover {
    background: var(--cream);
  }

  .compliment-item.pop-in {
    animation: complimentPop 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
  }

  @keyframes complimentPop {
    0% { transform: scale(0) translateX(-20px); opacity: 0; }
    100% { transform: scale(1) translateX(0); opacity: 1; }
  }

  .compliment-checkbox {
    width: 22px;
    height: 22px;
    min-width: 22px;
    border: 3px solid var(--deep-pink);
    border-radius: 4px;
    background: var(--red);
    display: flex;
    align-items: center;
    justify-content: center;
    transition: transform 0.2s;
  }

  .compliment-checkbox::after {
    content: '';
    width: 6px;
    height: 12px;
    border: solid white;
    border-width: 0 3px 3px 0;
    transform: rotate(45deg);
    margin-top: -2px;
  }

  .compliment-checkbox.shake {
    animation: checkShake 0.4s ease;
  }

  @keyframes checkShake {
    0%, 100% { transform: rotate(0deg); }
    20% { transform: rotate(-15deg) scale(1.2); }
    40% { transform: rotate(10deg) scale(1.1); }
    60% { transform: rotate(-8deg); }
    80% { transform: rotate(5deg); }
  }

  .compliment-label {
    font-family: 'VT323', monospace;
    font-size: 20px;
    color: var(--deep-pink);
  }

  .compliments-hint {
    font-family: 'VT323', monospace;
    font-size: 18px;
    color: var(--lavender);
    margin-bottom: 20px;
    min-height: 24px;
  }

  .compliments-next-btn {
    margin-top: 5px;
  }

  @media (max-width: 600px) {
    .compliments-card { padding: 25px 18px; width: 92vw; }
    .compliments-title { font-size: 11px; }
    .compliment-label { font-size: 18px; }
  }

  /* ========== STAGE 7: SLIDE PUZZLE ========== */
  #stage-puzzle {
    background: linear-gradient(180deg, var(--soft-pink) 0%, var(--baby-blue) 50%, var(--lavender) 100%);
  }

  .puzzle-card {
    background: var(--white);
    border: 5px solid var(--deep-pink);
    border-radius: 16px;
    padding: 30px 35px;
    text-align: center;
    box-shadow: 0 15px 40px rgba(0,0,0,0.12);
    animation: cardAppear 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
    position: relative;
    z-index: 2;
    max-width: 95vw;
  }

  .puzzle-title {
    font-family: 'Press Start 2P', cursive;
    font-size: 14px;
    color: var(--deep-pink);
    line-height: 2;
    margin-bottom: 20px;
  }

  .puzzle-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    grid-template-rows: repeat(3, 1fr);
    gap: 4px;
    width: 270px;
    height: 270px;
    margin: 0 auto 15px;
    background: var(--lavender);
    border: 4px solid var(--deep-pink);
    border-radius: 6px;
    padding: 4px;
  }

  .puzzle-tile {
    background-size: 270px 270px;
    border-radius: 4px;
    cursor: pointer;
    transition: transform 0.15s ease;
    position: relative;
    border: 2px solid rgba(255,255,255,0.3);
  }

  .puzzle-tile:hover {
    transform: scale(1.03);
    border-color: var(--deep-pink);
  }

  .puzzle-tile.empty {
    background: transparent !important;
    border: none;
    cursor: default;
  }

  .puzzle-tile.empty:hover {
    transform: none;
  }

  .puzzle-hint {
    font-family: 'VT323', monospace;
    font-size: 18px;
    color: var(--lavender);
    min-height: 24px;
  }

  .puzzle-solved-overlay {
    position: absolute;
    inset: 0;
    background: rgba(255, 245, 245, 0.92);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 10;
  }

  .puzzle-solved-overlay.active {
    display: flex;
  }

  .puzzle-solved-card {
    background: var(--white);
    border: 6px solid var(--deep-pink);
    border-radius: 16px;
    padding: 45px 55px;
    text-align: center;
    box-shadow:
      0 0 0 4px var(--soft-pink),
      0 0 0 8px var(--lavender),
      0 20px 60px rgba(0,0,0,0.15);
    animation: cardAppear 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
  }

  .puzzle-solved-text {
    font-family: 'Press Start 2P', cursive;
    font-size: 20px;
    color: var(--red);
    line-height: 2;
    margin-bottom: 25px;
    animation: rainbowText 2s ease-in-out infinite;
  }

  @media (max-width: 600px) {
    .puzzle-grid { width: 220px; height: 220px; }
    .puzzle-tile { background-size: 220px 220px; }
    .puzzle-card { padding: 20px 18px; }
    .puzzle-title { font-size: 11px; }
    .puzzle-solved-text { font-size: 15px; }
    .puzzle-solved-card { padding: 30px 25px; }
  }

  /* ========== STAGE 8: CELEBRATION ========== */
  #stage-celebrate {
    background: linear-gradient(135deg, var(--soft-pink) 0%, var(--lavender) 40%, var(--baby-blue) 70%, var(--soft-pink) 100%);
    background-size: 300% 300%;
    animation: gradientShift 4s ease infinite;
  }

  @keyframes gradientShift {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
  }

  .celebrate-card {
    background: var(--white);
    border: 6px solid var(--deep-pink);
    border-radius: 16px;
    padding: 50px 60px;
    text-align: center;
    box-shadow:
      0 0 0 4px var(--soft-pink),
      0 0 0 8px var(--lavender),
      0 20px 60px rgba(0,0,0,0.15);
    animation: cardAppear 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
    position: relative;
    z-index: 2;
    max-width: 90vw;
  }

  @keyframes cardAppear {
    0% { transform: scale(0) rotate(-10deg); opacity: 0; }
    100% { transform: scale(1) rotate(0deg); opacity: 1; }
  }

  .celebrate-emoji {
    font-size: 64px;
    margin-bottom: 20px;
    animation: heartBeat 1s ease-in-out infinite;
  }

  .celebrate-title {
    font-family: 'Press Start 2P', cursive;
    font-size: 22px;
    color: var(--red);
    line-height: 2;
    margin-bottom: 15px;
    animation: rainbowText 2s ease-in-out infinite;
  }

  @keyframes rainbowText {
    0%, 100% { color: var(--red); }
    33% { color: var(--deep-pink); }
    66% { color: var(--lavender); }
  }

  .celebrate-subtitle {
    font-family: 'Press Start 2P', cursive;
    font-size: 12px;
    color: var(--lavender);
    line-height: 2.2;
  }

  /* Confetti */
  .confetti-container {
    position: absolute;
    inset: 0;
    pointer-events: none;
    overflow: hidden;
    z-index: 1;
  }

  .confetti {
    position: absolute;
    top: -20px;
    animation: confettiFall linear infinite;
  }

  @keyframes confettiFall {
    0% { transform: translateY(-20px) rotate(0deg); opacity: 1; }
    100% { transform: translateY(100vh) rotate(720deg); opacity: 0.6; }
  }

  /* Hearts rain for celebration */
  .hearts-rain {
    position: absolute;
    inset: 0;
    pointer-events: none;
    overflow: hidden;
    z-index: 1;
  }

  .rain-heart {
    position: absolute;
    top: -30px;
    animation: heartRain linear infinite;
  }

  @keyframes heartRain {
    0% { transform: translateY(-30px) scale(1); opacity: 0.9; }
    100% { transform: translateY(100vh) scale(0.5); opacity: 0; }
  }

  /* ========== SCREEN FLASH ========== */
  .flash-overlay {
    position: fixed;
    inset: 0;
    background: white;
    z-index: 999;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.15s;
  }
  .flash-overlay.active {
    opacity: 1;
  }

  /* ========== RESPONSIVE ========== */
  @media (max-width: 600px) {
    .play-btn { width: 120px; height: 120px; }
    .play-triangle { border-width: 25px 0 25px 44px; margin-left: 8px; }
    .play-title { font-size: 11px; }
    .question-text { font-size: 13px; margin-bottom: 30px; }
    .btn-yes, .btn-no { font-size: 11px; padding: 14px 24px; }
    .celebrate-title { font-size: 16px; }
    .celebrate-subtitle { font-size: 9px; }
    .celebrate-card { padding: 30px 25px; }
    .envelope-container { width: 220px; height: 170px; }
    .envelope-body { width: 220px; height: 150px; }
    .envelope-flap { border-left: 110px solid transparent; border-right: 110px solid transparent; border-top: 80px solid var(--pink); }
    .envelope-flap-border { border-left: 114px solid transparent; border-right: 114px solid transparent; border-top: 84px solid var(--deep-pink); }
    .envelope-letter { width: 190px; }
  }
</style>
</head>
<body>

<!-- Flash overlay for transitions -->
<div class="flash-overlay" id="flash"></div>

<!-- ========== STAGE 1: PLAY BUTTON ========== -->
<div class="stage active" id="stage-play">
  <div class="floating-hearts" id="floatingHearts"></div>
  <div class="play-wrapper">
    <div class="play-title">~ a special message ~<br>just for you ~</div>
    <button class="play-btn" id="playBtn" onclick="goToEnvelope()">
      <div class="pixel-dots">
        <span></span><span></span><span></span>
        <span></span><span></span><span></span>
      </div>
      <div class="play-triangle"></div>
    </button>
    <div class="play-hint">[ PRESS PLAY ]</div>
  </div>
</div>

<!-- ========== STAGE 2: ENVELOPE ========== -->
<div class="stage" id="stage-envelope">
  <div class="clouds-container" id="envelopeClouds"></div>
  <div class="envelope-hint">tap to open</div>
  <div class="envelope-container" id="envelope" onclick="openEnvelope()">
    <div class="envelope-seal pixel-heart"></div>
    <div class="envelope-flap-border"></div>
    <div class="envelope-flap"></div>
    <div class="envelope-letter">
      <div class="envelope-letter-text">FOR YOU</div>
    </div>
    <div class="envelope-body"></div>
    <!-- sparkles -->
    <div class="sparkle" style="top:-10px;left:20px;animation-delay:0s;"></div>
    <div class="sparkle" style="top:30px;right:-15px;animation-delay:0.4s;"></div>
    <div class="sparkle" style="bottom:-5px;left:50%;animation-delay:0.8s;"></div>
    <div class="sparkle" style="top:50%;left:-12px;animation-delay:1.2s;"></div>
  </div>
</div>

<!-- ========== STAGE 3: VALENTINE QUESTION ========== -->
<div class="stage" id="stage-question">
  <div class="clouds-container" id="questionClouds"></div>
  <div class="question-emoji pixel-heart-lg"></div>
  <div class="question-text">Tanieal...<br>Will you be<br>my Valentine?</div>
  <div class="btn-container" id="btnContainer">
    <button class="btn-yes" onclick="sayYes()">YES!</button>
    <button class="btn-no" id="btnNo">No...</button>
  </div>
</div>

<!-- ========== STAGE 4: LOVE SLIDER ========== -->
<div class="stage" id="stage-slider">
  <div class="clouds-container" id="sliderClouds"></div>
  <div class="slider-card">
    <div class="slider-title">How much do<br>you love me?</div>
    <div class="slider-wrapper">
      <div class="slider-labels">
        <span>a lot</span>
        <span>so much</span>
        <span>infinity</span>
      </div>
      <input type="range" id="loveSlider" min="0" max="100" value="100" class="love-slider">
      <div class="slider-value" id="sliderValue">infinity</div>
    </div>
    <div class="slider-hint" id="sliderHint"></div>
    <button class="btn-yes slider-next-btn" id="sliderNextBtn" onclick="goToCelebrate()">NEXT</button>
  </div>
</div>

<!-- ========== STAGE 5: TYPING ========== -->
<div class="stage" id="stage-typing">
  <div class="clouds-container" id="typingClouds"></div>
  <div class="typing-card">
    <div class="typing-title">Tell me why<br>you love me</div>
    <div class="typing-box" id="typingBox">
      <span id="typedText"></span><span class="typing-cursor">_</span>
    </div>
    <div class="typing-hint" id="typingHint">go ahead, type anything...</div>
    <button class="btn-yes typing-next-btn" id="typingNextBtn" onclick="goToCelebrateFromTyping()" style="display:none;">SUBMIT</button>
  </div>
</div>

<!-- ========== STAGE 6: COMPLIMENTS ========== -->
<div class="stage" id="stage-compliments">
  <div class="clouds-container" id="complimentsClouds"></div>
  <div class="compliments-card" id="complimentsCard">
    <div class="compliments-title">Uncheck the ones<br>that don't apply</div>
    <div class="compliments-list" id="complimentsList"></div>
    <div class="compliments-hint" id="complimentsHint">go ahead, try to uncheck one</div>
    <button class="btn-yes compliments-next-btn" id="complimentsNextBtn" onclick="goToCelebrateFromCompliments()">NEXT</button>
  </div>
</div>

<!-- ========== STAGE 7: SLIDE PUZZLE ========== -->
<div class="stage" id="stage-puzzle">
  <div class="clouds-container" id="puzzleClouds"></div>
  <div class="puzzle-card">
    <div class="puzzle-title">Solve the puzzle</div>
    <div class="puzzle-grid" id="puzzleGrid"></div>
    <div class="puzzle-hint" id="puzzleHint">click a tile next to the gap</div>
  </div>
  <div class="puzzle-solved-overlay" id="puzzleSolvedOverlay">
    <div class="puzzle-solved-card">
      <div class="puzzle-solved-text">you complete me!</div>
      <button class="btn-yes" onclick="goToQuestionFromPuzzle()">NEXT</button>
    </div>
  </div>
</div>

<!-- ========== STAGE 8: CELEBRATION ========== -->
<div class="stage" id="stage-celebrate">
  <div class="confetti-container" id="confettiContainer"></div>
  <div class="hearts-rain" id="heartsRain"></div>
  <div class="celebrate-card">
    <div class="celebrate-title">WOOOOO!!!<br>MY CUTIE!!!!</div>
    <div class="celebrate-subtitle">happy Valentine's Day</div>
  </div>
</div>

<script>
  // ======== FLOATING HEARTS (Stage 1) ========
  const heartColors = ['var(--pink)', 'var(--soft-pink)', 'var(--lavender)', 'var(--baby-blue)', 'var(--red)', 'var(--deep-pink)'];
  const heartsContainer = document.getElementById('floatingHearts');

  function spawnFloatingHeart() {
    const heart = document.createElement('div');
    heart.className = 'heart pixel-heart-sm';
    const color = heartColors[Math.floor(Math.random() * heartColors.length)];
    heart.style.setProperty('--h-color', color);
    heart.style.left = Math.random() * 100 + '%';
    const size = 0.6 + Math.random() * 1;
    heart.style.transform = `scale(${size})`;
    heart.style.animationDuration = (4 + Math.random() * 6) + 's';
    heart.style.animationDelay = Math.random() * 2 + 's';
    heartsContainer.appendChild(heart);
    setTimeout(() => heart.remove(), 12000);
  }

  setInterval(spawnFloatingHeart, 600);
  for (let i = 0; i < 8; i++) setTimeout(spawnFloatingHeart, i * 200);

  // ======== CLOUDS ========
  function createClouds(containerId, count) {
    const container = document.getElementById(containerId);
    for (let i = 0; i < count; i++) {
      const cloud = document.createElement('div');
      cloud.className = 'pixel-cloud';
      const w = 80 + Math.random() * 100;
      cloud.style.width = w + 'px';
      cloud.style.height = (w * 0.4) + 'px';
      cloud.style.top = (Math.random() * 70) + '%';
      cloud.style.animationDuration = (15 + Math.random() * 20) + 's';
      cloud.style.animationDelay = (-Math.random() * 30) + 's';
      cloud.style.opacity = 0.4 + Math.random() * 0.4;
      container.appendChild(cloud);
    }
  }

  createClouds('envelopeClouds', 6);
  createClouds('questionClouds', 8);

  // ======== STAGE TRANSITIONS ========
  function flash(callback) {
    const el = document.getElementById('flash');
    el.classList.add('active');
    setTimeout(() => {
      callback();
      setTimeout(() => el.classList.remove('active'), 300);
    }, 200);
  }

  function switchStage(from, to) {
    document.getElementById(from).classList.remove('active');
    document.getElementById(to).classList.add('active');
  }

  function goToEnvelope() {
    flash(() => switchStage('stage-play', 'stage-envelope'));
  }

  let envelopeOpened = false;
  function openEnvelope() {
    if (envelopeOpened) return;
    const env = document.getElementById('envelope');
    env.classList.add('opening');
    envelopeOpened = true;

    setTimeout(() => {
      flash(() => {
        switchStage('stage-envelope', 'stage-slider');
        initSliderGimmick();
      });
    }, 1400);
  }

  // ======== FLEEING NO BUTTON ========
  function initNoButton() {
    const btn = document.getElementById('btnNo');
    const sensitivity = 120;

    function flee(e) {
      const rect = btn.getBoundingClientRect();
      const btnCX = rect.left + rect.width / 2;
      const btnCY = rect.top + rect.height / 2;

      const dx = e.clientX - btnCX;
      const dy = e.clientY - btnCY;
      const dist = Math.sqrt(dx * dx + dy * dy);

      if (dist < sensitivity) {
        const vw = window.innerWidth;
        const vh = window.innerHeight;
        const bw = rect.width;
        const bh = rect.height;
        const pad = 20;

        let newX, newY;
        let attempts = 0;
        do {
          newX = pad + Math.random() * (vw - bw - pad * 2);
          newY = pad + Math.random() * (vh - bh - pad * 2);
          attempts++;
        } while (
          Math.sqrt((e.clientX - (newX + bw/2))**2 + (e.clientY - (newY + bh/2))**2) < sensitivity * 1.5
          && attempts < 20
        );

        btn.style.position = 'fixed';
        btn.style.left = newX + 'px';
        btn.style.top = newY + 'px';
        btn.style.right = 'auto';
      }
    }

    document.addEventListener('mousemove', flee);
    document.addEventListener('touchmove', (e) => {
      const touch = e.touches[0];
      flee({ clientX: touch.clientX, clientY: touch.clientY });
    });

    // Also flee on touch start (for mobile)
    btn.addEventListener('touchstart', (e) => {
      e.preventDefault();
      const touch = e.touches[0];
      flee({ clientX: touch.clientX, clientY: touch.clientY });
    });
  }

  // ======== CELEBRATION ========
  let audioCtx;
  function playVictorySound() {
    try {
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();

      const notes = [523.25, 659.25, 783.99, 1046.50]; // C5, E5, G5, C6
      notes.forEach((freq, i) => {
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = 'square'; // Pixel/retro sound
        osc.frequency.value = freq;
        gain.gain.setValueAtTime(0.08, audioCtx.currentTime + i * 0.15);
        gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + i * 0.15 + 0.5);
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        osc.start(audioCtx.currentTime + i * 0.15);
        osc.stop(audioCtx.currentTime + i * 0.15 + 0.5);
      });

      // Second arpeggio
      setTimeout(() => {
        const notes2 = [659.25, 783.99, 1046.50, 1318.51];
        notes2.forEach((freq, i) => {
          const osc = audioCtx.createOscillator();
          const gain = audioCtx.createGain();
          osc.type = 'square';
          osc.frequency.value = freq;
          gain.gain.setValueAtTime(0.08, audioCtx.currentTime + i * 0.12);
          gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + i * 0.12 + 0.6);
          osc.connect(gain);
          gain.connect(audioCtx.destination);
          osc.start(audioCtx.currentTime + i * 0.12);
          osc.stop(audioCtx.currentTime + i * 0.12 + 0.6);
        });
      }, 600);

      // Background heartbeat melody loop
      setTimeout(() => {
        function playLoop() {
          const melody = [523.25, 0, 659.25, 0, 783.99, 659.25, 523.25, 0];
          melody.forEach((freq, i) => {
            if (freq === 0) return;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = 'triangle';
            osc.frequency.value = freq;
            gain.gain.setValueAtTime(0.04, audioCtx.currentTime + i * 0.25);
            gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + i * 0.25 + 0.24);
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start(audioCtx.currentTime + i * 0.25);
            osc.stop(audioCtx.currentTime + i * 0.25 + 0.25);
          });
        }
        playLoop();
        setInterval(playLoop, 2200);
      }, 1400);

    } catch(e) {
      console.log('Audio not supported');
    }
  }

  function spawnConfetti() {
    const container = document.getElementById('confettiContainer');
    const colors = ['#FFB6C1', '#C8A2D4', '#A8D8EA', '#FFD700', '#FF6B8A', '#98D8C8', '#F7DC6F'];

    function createPiece() {
      const piece = document.createElement('div');
      piece.className = 'confetti';
      piece.style.left = Math.random() * 100 + '%';
      piece.style.width = (6 + Math.random() * 10) + 'px';
      piece.style.height = (6 + Math.random() * 10) + 'px';
      piece.style.background = colors[Math.floor(Math.random() * colors.length)];
      piece.style.animationDuration = (2 + Math.random() * 3) + 's';
      piece.style.animationDelay = Math.random() * 3 + 's';
      piece.style.borderRadius = Math.random() > 0.5 ? '50%' : '2px';
      container.appendChild(piece);
      setTimeout(() => piece.remove(), 6000);
    }

    for (let i = 0; i < 50; i++) setTimeout(() => createPiece(), i * 60);
    setInterval(() => { for(let i=0;i<3;i++) createPiece(); }, 400);
  }

  function spawnHeartsRain() {
    const container = document.getElementById('heartsRain');
    function createHeart() {
      const h = document.createElement('div');
      h.className = 'rain-heart pixel-heart-sm';
      const color = heartColors[Math.floor(Math.random() * heartColors.length)];
      h.style.setProperty('--h-color', color);
      h.style.left = Math.random() * 100 + '%';
      const size = 0.5 + Math.random() * 1;
      h.style.transform = `scale(${size})`;
      h.style.animationDuration = (3 + Math.random() * 4) + 's';
      h.style.animationDelay = Math.random() * 2 + 's';
      container.appendChild(h);
      setTimeout(() => h.remove(), 8000);
    }
    for (let i = 0; i < 15; i++) setTimeout(() => createHeart(), i * 150);
    setInterval(createHeart, 500);
  }

  function sayYes() {
    flash(() => {
      switchStage('stage-question', 'stage-celebrate');
      playVictorySound();
      spawnConfetti();
      spawnHeartsRain();
    });
  }

  // ======== LOVE SLIDER GIMMICK ========
  function initSliderGimmick() {
    createClouds('sliderClouds', 6);

    const slider = document.getElementById('loveSlider');
    const valueDisplay = document.getElementById('sliderValue');
    const hint = document.getElementById('sliderHint');
    let creepInterval = null;
    let isUserDragging = false;
    let shakeCount = 0;

    const messages = [
      { min: 90, text: 'infinity', hint: '' },
      { min: 70, text: 'soooo much', hint: 'nope, higher!' },
      { min: 50, text: 'a whole lot', hint: 'hmm... are you sure?' },
      { min: 30, text: 'pretty good', hint: 'wait no come back!!' },
      { min: 10, text: 'some??', hint: 'EXCUSE ME?!' },
      { min: 0, text: 'WRONG', hint: 'nice try >:(' },
    ];

    function getLabel(val) {
      for (const m of messages) {
        if (val >= m.min) return m;
      }
      return messages[messages.length - 1];
    }

    function updateDisplay() {
      const val = parseInt(slider.value);
      const msg = getLabel(val);
      valueDisplay.textContent = msg.text;
      hint.textContent = msg.hint;

      if (val < 90) {
        valueDisplay.classList.add('nope');
        setTimeout(() => valueDisplay.classList.remove('nope'), 300);
      }
    }

    // Slider always creeps back to max
    function startCreep() {
      if (creepInterval) return;
      creepInterval = setInterval(() => {
        if (isUserDragging) return;
        const current = parseInt(slider.value);
        if (current < 100) {
          // Speed increases the further away from max
          const diff = 100 - current;
          const step = Math.max(1, Math.floor(diff / 8));
          slider.value = Math.min(100, current + step);
          updateDisplay();
        }
      }, 50);
    }

    slider.addEventListener('input', () => {
      isUserDragging = true;
      updateDisplay();
      shakeCount++;
    });

    slider.addEventListener('mousedown', () => { isUserDragging = true; });
    slider.addEventListener('touchstart', () => { isUserDragging = true; });

    slider.addEventListener('mouseup', () => {
      isUserDragging = false;
      // Snap back faster on release
      snapBack();
    });
    slider.addEventListener('touchend', () => {
      isUserDragging = false;
      snapBack();
    });

    function snapBack() {
      const snapInterval = setInterval(() => {
        const current = parseInt(slider.value);
        if (current >= 100 || isUserDragging) {
          clearInterval(snapInterval);
          updateDisplay();
          return;
        }
        const diff = 100 - current;
        const step = Math.max(2, Math.floor(diff / 4));
        slider.value = Math.min(100, current + step);
        updateDisplay();
      }, 30);
    }

    startCreep();
    updateDisplay();
  }

  function goToCelebrate() {
    flash(() => {
      switchStage('stage-slider', 'stage-typing');
      initTypingGimmick();
    });
  }

  // ======== TYPING GIMMICK ========
  function initTypingGimmick() {
    createClouds('typingClouds', 6);

    const secret = "Because he's so cool and funny !!";
    let charIndex = 0;
    const typedText = document.getElementById('typedText');
    const hint = document.getElementById('typingHint');
    const nextBtn = document.getElementById('typingNextBtn');
    let finished = false;

    function advanceChar() {
      if (charIndex >= secret.length) {
        finished = true;
        hint.textContent = "hmm... looks about right";
        nextBtn.style.display = '';
        return;
      }
      typedText.textContent = secret.substring(0, charIndex + 1);
      charIndex++;

      if (charIndex === 1) {
        hint.textContent = "wait...";
      } else if (charIndex === 10) {
        hint.textContent = "hehe";
      } else if (charIndex === 20) {
        hint.textContent = "keep going...";
      }
    }

    function handleKey(e) {
      if (finished) return;
      e.preventDefault();
      advanceChar();
    }

    document.addEventListener('keydown', handleKey);

    // Mobile support: tap the box to type
    document.getElementById('typingBox').addEventListener('click', () => {
      if (finished) return;
      advanceChar();
    });

    // Touch support: each tap advances
    document.getElementById('typingBox').addEventListener('touchstart', (e) => {
      if (finished) return;
      e.preventDefault();
      advanceChar();
    });
  }

  function goToCelebrateFromTyping() {
    flash(() => {
      switchStage('stage-typing', 'stage-compliments');
      initComplimentsGimmick();
    });
  }

  // ======== COMPLIMENTS GIMMICK ========
  function initComplimentsGimmick() {
    createClouds('complimentsClouds', 6);

    const allCompliments = [
      "sooo pretty",
      "really thoughtful",
      "can't drive...... yet",
      "so kind",
      "beautiful",
      "so cool",
      "Solomon 4:7",
      "you are delectable",
      "I love being around you",
      "I'm so proud of you"
    ];

    const startCount = 3;
    let nextIndex = startCount;
    const list = document.getElementById('complimentsList');
    const hint = document.getElementById('complimentsHint');
    const card = document.getElementById('complimentsCard');

    const hintMessages = [
      "nice try",
      "nope, that one stays",
      "you can't remove facts",
      "it's TRUE though",
      "not optional",
      "that's just science",
      "try again... or don't",
      "denied",
      "lol you thought",
      "absolutely not"
    ];
    let hintIndex = 0;

    function addCompliment(text, animate) {
      const item = document.createElement('div');
      item.className = 'compliment-item' + (animate ? ' pop-in' : '');

      const checkbox = document.createElement('div');
      checkbox.className = 'compliment-checkbox';

      const label = document.createElement('span');
      label.className = 'compliment-label';
      label.textContent = text;

      item.appendChild(checkbox);
      item.appendChild(label);
      list.appendChild(item);

      item.addEventListener('click', () => {
        // Shake the checkbox
        checkbox.classList.remove('shake');
        void checkbox.offsetWidth;
        checkbox.classList.add('shake');

        // Update hint
        hint.textContent = hintMessages[hintIndex % hintMessages.length];
        hintIndex++;

        // Spawn next compliment from the list
        if (nextIndex < allCompliments.length) {
          addCompliment(allCompliments[nextIndex], true);
          nextIndex++;
          // Scroll card to bottom to show new one
          setTimeout(() => card.scrollTop = card.scrollHeight, 100);
        }
      });
    }

    // Add first 3 compliments
    for (let i = 0; i < startCount; i++) {
      addCompliment(allCompliments[i], false);
    }
  }

  function goToCelebrateFromCompliments() {
    flash(() => {
      switchStage('stage-compliments', 'stage-puzzle');
      initPuzzle();
    });
  }

  // ======== SLIDE PUZZLE ========
  function initPuzzle() {
    createClouds('puzzleClouds', 6);

    const grid = document.getElementById('puzzleGrid');
    const hint = document.getElementById('puzzleHint');
    const size = 3;

    // =====================================================
    // CUSTOM IMAGE: Replace this URL with your own image!
    // Use a square image for best results (e.g. 540x540).
    // Just change the string below:
    const IMAGE_URL = '4BDBF238-906F-4A73-96E2-089DC4009B7F_1_201_a.png';
    // =====================================================

    // Generate a pixel heart image via canvas if no custom image
    function generateHeartImage() {
      const canvas = document.createElement('canvas');
      canvas.width = 270;
      canvas.height = 270;
      const ctx = canvas.getContext('2d');

      // Background
      const grad = ctx.createLinearGradient(0, 0, 270, 270);
      grad.addColorStop(0, '#FFD1DC');
      grad.addColorStop(0.5, '#C8A2D4');
      grad.addColorStop(1, '#A8D8EA');
      ctx.fillStyle = grad;
      ctx.fillRect(0, 0, 270, 270);

      // Pixel heart pattern (16x16 grid scaled up)
      const heart = [
        '..xxxx..xxxx..',
        '.xxxxxxxx.xxx.',
        'xxxxxxxxxxxxxx',
        'xxxxxxxxxxxxxx',
        'xxxxxxxxxxxxxx',
        '.xxxxxxxxxxxx.',
        '..xxxxxxxxxx..',
        '...xxxxxxxx...',
        '....xxxxxx....',
        '.....xxxx.....',
        '......xx......',
      ];

      const pixelSize = 16;
      const offsetX = (270 - 14 * pixelSize) / 2;
      const offsetY = (270 - 11 * pixelSize) / 2 - 5;

      ctx.fillStyle = '#E74C6F';
      heart.forEach((row, y) => {
        for (let x = 0; x < row.length; x++) {
          if (row[x] === 'x') {
            ctx.fillRect(offsetX + x * pixelSize, offsetY + y * pixelSize, pixelSize - 1, pixelSize - 1);
          }
        }
      });

      // Add subtle grid lines for pixel look
      ctx.strokeStyle = 'rgba(255,255,255,0.15)';
      ctx.lineWidth = 1;
      for (let i = 0; i <= 3; i++) {
        ctx.beginPath();
        ctx.moveTo(i * 90, 0);
        ctx.lineTo(i * 90, 270);
        ctx.stroke();
        ctx.beginPath();
        ctx.moveTo(0, i * 90);
        ctx.lineTo(270, i * 90);
        ctx.stroke();
      }

      return canvas.toDataURL();
    }

    function buildPuzzle(imgSrc) {
      // Tiles numbered 0-8, where 8 is the empty space
      let tiles = [0, 1, 2, 3, 4, 5, 6, 7, 8];

      // Shuffle with solvable permutation
      function isSolvable(arr) {
        let inversions = 0;
        const filtered = arr.filter(t => t !== 8);
        for (let i = 0; i < filtered.length; i++) {
          for (let j = i + 1; j < filtered.length; j++) {
            if (filtered[i] > filtered[j]) inversions++;
          }
        }
        return inversions % 2 === 0;
      }

      do {
        for (let i = tiles.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [tiles[i], tiles[j]] = [tiles[j], tiles[i]];
        }
      } while (!isSolvable(tiles) || isSolved(tiles));

      function isSolved(arr) {
        return arr.every((t, i) => t === i);
      }

      const puzzleWidth = window.innerWidth <= 600 ? 220 : 270;

      function render() {
        grid.innerHTML = '';
        tiles.forEach((tile, index) => {
          const el = document.createElement('div');
          el.className = 'puzzle-tile' + (tile === 8 ? ' empty' : '');

          if (tile !== 8) {
            const col = tile % size;
            const row = Math.floor(tile / size);
            const tileSize = puzzleWidth / size;
            el.style.backgroundImage = `url('${imgSrc}')`;
            el.style.backgroundSize = `${puzzleWidth}px ${puzzleWidth}px`;
            el.style.backgroundPosition = `-${col * tileSize}px -${row * tileSize}px`;
          }

          el.addEventListener('click', () => {
            const emptyIndex = tiles.indexOf(8);
            const row = Math.floor(index / size);
            const col = index % size;
            const emptyRow = Math.floor(emptyIndex / size);
            const emptyCol = emptyIndex % size;

            const adjacent = (Math.abs(row - emptyRow) + Math.abs(col - emptyCol)) === 1;

            if (adjacent) {
              [tiles[index], tiles[emptyIndex]] = [tiles[emptyIndex], tiles[index]];
              render();

              if (isSolved(tiles)) {
                setTimeout(() => {
                  hint.textContent = '';
                  // Show completed image briefly
                  grid.innerHTML = '';
                  const full = document.createElement('div');
                  full.style.cssText = `
                    grid-column: 1 / -1; grid-row: 1 / -1;
                    background-image: url('${imgSrc}');
                    background-size: cover;
                    border-radius: 4px;
                    animation: cardAppear 0.4s ease;
                  `;
                  grid.style.gridTemplateColumns = '1fr';
                  grid.style.gridTemplateRows = '1fr';
                  grid.appendChild(full);

                  setTimeout(() => {
                    document.getElementById('puzzleSolvedOverlay').classList.add('active');
                  }, 800);
                }, 300);
              }
            }
          });

          grid.appendChild(el);
        });
      }

      render();
    }

    if (IMAGE_URL) {
      buildPuzzle(IMAGE_URL);
    } else {
      buildPuzzle(generateHeartImage());
    }
  }

  function goToQuestionFromPuzzle() {
    flash(() => {
      switchStage('stage-puzzle', 'stage-question');
      initNoButton();
    });
  }
</script>
</body>
</html>
